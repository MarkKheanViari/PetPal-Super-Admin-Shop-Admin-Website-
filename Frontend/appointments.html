<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PetPal - All Appointments</title>
    <link rel="stylesheet" href="appointments.css" />
    <style>
      /* Custom Modal Styles for Dialogs */
      #customModalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      #customModal {
        background: #fff;
        border: 2px solid #ff8c00;
        border-radius: 8px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      #customModal p {
        margin: 20px 0;
      }
      #customModal button {
        background-color: #ff8c00;
        border: none;
        color: #fff;
        padding: 10px 20px;
        margin: 0 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
      }
      #customModal button:hover {
        background-color: #e37f00;
      }
    </style>
    <script>
      (function () {
        // Create modal overlay element if it doesn't exist
        const modalOverlay = document.createElement("div");
        modalOverlay.id = "customModalOverlay";
        modalOverlay.innerHTML = `
          <div id="customModal">
            <p id="customModalMessage"></p>
            <div id="customModalButtons"></div>
          </div>
        `;
        document.addEventListener("DOMContentLoaded", function () {
          document.body.appendChild(modalOverlay);
        });

        // Override window.alert to use custom modal
        window.alert = function (message) {
          return new Promise((resolve) => {
            const modalMessage = document.getElementById("customModalMessage");
            const modalButtons = document.getElementById("customModalButtons");
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button id="customOkButton">OK</button>`;
            modalOverlay.style.display = "flex";
            document.getElementById("customOkButton").onclick = function () {
              modalOverlay.style.display = "none";
              resolve();
            };
          });
        };

        // Override window.confirm to use custom modal, returns true (Yes) or false (No)
        window.confirm = function (message) {
          return new Promise((resolve) => {
            const modalMessage = document.getElementById("customModalMessage");
            const modalButtons = document.getElementById("customModalButtons");
            modalMessage.textContent = message;
            modalButtons.innerHTML = `
              <button id="customYesButton">Yes</button>
              <button id="customNoButton">No</button>
            `;
            modalOverlay.style.display = "flex";
            document.getElementById("customYesButton").onclick = function () {
              modalOverlay.style.display = "none";
              resolve(true);
            };
            document.getElementById("customNoButton").onclick = function () {
              modalOverlay.style.display = "none";
              resolve(false);
            };
          });
        };
      })();
    </script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="nav-left">
        <img src="PETPAL LOGO.png" alt="PetPal Logo" class="logo" />
      </div>
      <!-- Hamburger menu button using the new function name -->
      <button class="menu-btn" onclick="toggleNav()">‚ò∞</button>
      <ul class="nav-right">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="product_inventory.html" class="nav-link">Products</a></li>
        <li><a href="orders.html" class="nav-link">Orders</a></li>
        <li><a href="appointments.html" class="nav-link active">Services</a></li>
        <li><a href="grooming_appointments.html" class="nav-link">Appointments</a></li>
        <li class="notification-bell">
          <i class="bell-icon">üîî</i>
          <span id="notifCount" class="badge">0</span>
          <div id="notifDropdown" class="notif-dropdown">
            <div class="notif-header">
              <span class="notif-title">Notifications</span>
              <button type="button" id="notifExitBtn" class="notif-exit-btn">X</button>
            </div>
            <div class="notif-filter">
              <button type="button" class="notif-filter-btn active" data-filter="all">All</button>
              <button type="button" class="notif-filter-btn" data-filter="order">Orders</button>
              <button type="button" class="notif-filter-btn" data-filter="appointment">Appointments</button>
            </div>
            <div id="notifItemsContainer">
              <!-- Notifications will be populated here -->
            </div>
          </div>
        </li>
      </ul>
    </nav>

    <!-- Header -->
    <header class="seller-header">
      <div class="seller-info">
        <div class="seller-avatar"></div>
        <div class="seller-details">
          <h1 id="welcomeText"></h1>
          <p class="seller-type">PetPal</p>
          <p class="seller-description">
            Manage your shop's orders, products, grooming, and veterinary
            services
          </p>
        </div>
      </div>
      <div class="btn-seller-pref">
        <button class="edit-profile">Edit Profile</button>
        <button onclick="logout()" class="logout-btn">Logout</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="content">
      <section class="appointments">
        <div class="head-service">
          <h2>Grooming Services</h2>
          <div class="service-buttons">
            <button
              class="view-details-btn"
              onclick="openAddServiceModal('Grooming')"
            >
              Add Grooming Service
            </button>
            <button
              class="view-details-btn-l"
              onclick="viewAppointments('grooming_appointments.html')"
            >
              View Grooming Appointments
            </button>
          </div>
        </div>
        <table id="groomingServicesTable" class="services-table">
          <thead>
            <tr>
              <th onclick="sortTable('groomingServicesTable', 0)">
                Service Name
              </th>
              <th onclick="sortTable('groomingServicesTable', 1)">Price</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Grooming service rows will be inserted here dynamically -->
          </tbody>
        </table>
      </section>

      <section class="appointments">
        <div class="head-service">
          <h2>Veterinary Services</h2>
          <div class="service-buttons">
            <button
              class="view-details-btn"
              onclick="openAddServiceModal('Veterinary')"
            >
              Add Veterinary Service
            </button>
            <button
              class="view-details-btn-l"
              onclick="viewAppointments('grooming_appointments.html')"
            >
              View Veterinary Appointments
            </button>
          </div>
        </div>
        <table id="veterinaryServicesTable" class="services-table">
          <thead>
            <tr>
              <th onclick="sortTable('veterinaryServicesTable', 0)">
                Service Name
              </th>
              <th onclick="sortTable('veterinaryServicesTable', 1)">Price</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Veterinary service rows will be inserted here dynamically -->
          </tbody>
        </table>
      </section>
    </main>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal">
      <div class="modal-content">
        <div class="service-head">
          <h2 id="addServiceModalTitle">Add New Service</h2>
          <button class="cancel-btn" onclick="closeModal('addServiceModal')">
            √ó
          </button>
        </div>

        <form id="addServiceForm">
          <div class="modal-section">
            <label><strong>Service Name:</strong></label>
            <select id="serviceOption" required>
              <option value="" disabled selected>Select Service</option>
            </select>
          </div>

          <div class="modal-section">
            <label><strong>Price:</strong></label>
            <input
              type="number"
              id="servicePrice"
              placeholder="Enter price"
              required
              step="0.01"
              min="0"
            />
          </div>

          <div class="modal-section">
            <label><strong>Description:</strong></label>
            <textarea
              id="serviceDescription"
              placeholder="Enter description"
              required
            ></textarea>
          </div>

          <div class="modal-section">
            <label><strong>Service Image:</strong></label>
            <input type="file" id="serviceImage" accept="image/*" required />
          </div>

          <button class="approve-btn" type="submit">Add Service</button>
        </form>
      </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="editServiceModal" class="modal">
      <div class="modal-content">
        <div class="service-head">
          <h2>Edit Service</h2>
          <button class="cancel-btn" onclick="closeModal('editServiceModal')">
            √ó
          </button>
        </div>
        <form id="editServiceForm">
          <input type="hidden" id="editServiceId" />

          <div class="modal-section">
            <label><strong>Service Name:</strong></label>
            <input type="text" id="editServiceName" readonly />
          </div>

          <div class="modal-section">
            <label><strong>Price:</strong></label>
            <input type="number" id="editServicePrice" required />
          </div>

          <div class="modal-section">
            <label><strong>Description:</strong></label>
            <textarea id="editServiceDescription" required></textarea>
          </div>

          <div class="modal-section">
            <label><strong>Service Image:</strong></label>
            <input type="file" id="editServiceImage" accept="image/*" />
            <img id="editPreviewImage" src="" alt="Current Image" style="width: 100%; max-height: 150px; object-fit: cover; margin-top: 10px;" />
          </div>

          <!-- Buttons Container -->
          <div class="modal-button">
            <button
              class="remove-btn"
              type="button"
              onclick="removeServiceFromModal()"
            >
              Remove Service
            </button>
            <button class="save-btn" type="submit">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <nav class="footer-nav">
        <a href="about_us.html" class="footer-link">About Us</a>
        <a href="contact.html" class="footer-link">Contact Us</a>
        <a href="terms.html" class="footer-link">Terms and Conditions</a>
        <a href="privacy.html" class="footer-link">Privacy Policy</a>
      </nav>
    </footer>

    <!-- Integrated JavaScript -->
    <script>
      function viewAppointments(page) {
        window.location.href = page;
      }

      (function () {
        // Base URL for API endpoints
        const apiBaseUrl = "http://192.168.1.65/backend/";

        // Service options arrays
        const groomingServicesList = [
          "Brushing",
          "Bathing",
          "Nail Trimming",
          "Ear Cleaning",
          "Teeth Brushing",
          "Deshedding Treatment",
          "Paw Pad Care",
          "Sanitary Trim",
          "Eye Cleaning",
          "Full Haircut/Styling",
          "Hand Stripping",
          "Flea & Tick Treatment",
          "Anal Gland Expression",
        ];

        const veterinaryServicesList = [
          "Wellness Exam",
          "Vaccination Check",
          "Parasite Screening",
          "Dental Checkup",
          "Nutritional Consultation",
          "Blood Tests & Lab Work",
          "X-ray & Ultrasound",
          "Allergy Testing",
          "Skin & Coat Exam",
          "Eye & Ear Exam",
          "Arthritis & Joint Health Check",
          "Kidney & Liver Function Tests",
          "Heart Health Check",
          "Injury or Trauma Exam",
          "Gastrointestinal Check",
          "Behavioral Consultation",
        ];

        // Hold the current service type for adding new services
        let currentServiceType = "";

        // ------------------------
        // Fetch & Populate Services
        // ------------------------

        // Fetch services based on type and populate corresponding table
        function fetchServices(serviceType, tableId) {
          const endpoint =
            serviceType.toLowerCase() === "grooming"
              ? "fetch_grooming_services.php"
              : "fetch_veterinary_services.php";

          fetch(apiBaseUrl + endpoint)
            .then((res) => {
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                return res.json();
            })
            .then((data) => {
                console.log(`Fetched ${serviceType} services:`, data);
                populateServicesTable(data, tableId);
            })
            .catch((err) =>
                console.error(`Error fetching ${serviceType} services:`, err)
            );
        }

        // Populate a given table with service data
        function populateServicesTable(data, tableId) {
          const tableBody = document
            .getElementById(tableId)
            .querySelector("tbody");
          tableBody.innerHTML = "";

          // Filter only non-removed (active) services
          const activeServices = data.services.filter(
            (service) => service.removed == 0
          );

          // Check if we have any active services
          if (activeServices.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td colspan="4" style="text-align: center; color: #666;">
                No service added yet
              </td>
            `;
            tableBody.appendChild(tr);
            return;
          }

          // Otherwise, populate rows as usual
          activeServices.forEach((service) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${service.service_name}</td>
              <td>‚Ç±${service.price}</td>
              <td>${service.description || "No description provided."}</td>
              <td>
                <button class="edit-btn" onclick='openEditModal(${JSON.stringify(
                  service
                )})'>
                  Edit
                </button>
              </td>
            `;
            tableBody.appendChild(tr);
          });
        }

        // ------------------------
        // Sorting Functionality
        // ------------------------

        // Sort table by a given column index
        function sortTable(tableId, colIndex) {
          const table = document.getElementById(tableId);
          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const isNumeric = colIndex === 1; // only Price column is numeric

          rows.sort((a, b) => {
            let cellA = a.cells[colIndex].textContent.trim();
            let cellB = b.cells[colIndex].textContent.trim();

            if (isNumeric) {
              cellA = parseFloat(cellA.replace("‚Ç±", ""));
              cellB = parseFloat(cellB.replace("‚Ç±", ""));
              return cellA - cellB;
            } else {
              return cellA.localeCompare(cellB);
            }
          });

          // Append sorted rows back to the tbody
          rows.forEach((row) => tbody.appendChild(row));
        }

        // ------------------------
        // Modal & Form Handling
        // ------------------------

        // Open a modal by ID
        function openModal(modalId) {
          document.getElementById(modalId).style.display = "flex";
        }

        // Open the Add Service modal and populate dropdown options
        function openAddServiceModal(serviceType) {
          currentServiceType = serviceType;
          document.getElementById(
            "addServiceModalTitle"
          ).innerText = `Add ${serviceType} Service`;

          const serviceOption = document.getElementById("serviceOption");
          serviceOption.innerHTML =
            '<option value="" disabled selected>Select Service</option>';

          // Fetch existing services to determine which ones are available
          fetch(apiBaseUrl + `fetch_${serviceType.toLowerCase()}_services.php`)
            .then((res) => {
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                return res.json();
            })
            .then((data) => {
                const activeServices = data.services
                    .filter((s) => s.removed == 0)
                    .map((s) => s.service_name);
                const removedServices = data.services
                    .filter((s) => s.removed == 1)
                    .map((s) => s.service_name);

                const availableServices = (
                    serviceType === "Grooming"
                    ? groomingServicesList
                    : veterinaryServicesList
                ).filter(
                    (service) =>
                        !activeServices.includes(service) ||
                        removedServices.includes(service)
                );

                availableServices.forEach((service) => {
                    const option = document.createElement("option");
                    option.value = service;
                    option.textContent = service;
                    serviceOption.appendChild(option);
                });

                document.getElementById("addServiceForm").reset();
                openModal("addServiceModal");
            })
            .catch((error) =>
                console.error("Error fetching services for modal:", error)
            );
        }

        // Close a modal by ID
        function closeModal(modalId) {
          document.getElementById(modalId).style.display = "none";
        }

        // Open the Edit Service modal and populate with service details
        function openEditModal(service) {
    console.log("Opening edit modal with service:", service); // Debug log
    document.getElementById("editServiceId").value = service.id || service.service_id || ''; // Fallback to service_id if id is undefined
    document.getElementById("editServiceName").value = service.service_name;
    document.getElementById("editServicePrice").value = service.price;
    document.getElementById("editServiceDescription").value = service.description;

    // Load image preview
    document.getElementById("editPreviewImage").src = `http://192.168.1.65/backend/${service.image}`;
    
    openModal("editServiceModal");
}

        // Remove a service from within the edit modal
        function removeServiceFromModal() {
          const serviceName = document.getElementById("editServiceName").value;
          if (!confirm(`Are you sure you want to remove "${serviceName}"?`))
            return;

          fetch(apiBaseUrl + "remove_service.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ service_name: serviceName }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert(`‚úÖ ${serviceName} removed successfully!`);
                closeModal("editServiceModal");
                refreshServices();
                addToDropdown(serviceName);
              } else {
                alert(
                  `‚ùå Failed to remove service: ${
                    data.error || "Unknown error"
                  }`
                );
              }
            })
            .catch((err) =>
              console.error("Error removing service from modal:", err)
            );
        }

        // Add a removed service back to the Add Service dropdown
        function addToDropdown(serviceName) {
          const serviceOption = document.getElementById("serviceOption");
          const existingOption = [...serviceOption.options].find(
            (opt) => opt.value === serviceName
          );
          if (!existingOption) {
            const option = document.createElement("option");
            option.value = serviceName;
            option.textContent = serviceName;
            serviceOption.appendChild(option);
          }
        }

        // Remove a service from the dropdown after it‚Äôs added
        function removeFromDropdown(serviceName) {
          const serviceOption = document.getElementById("serviceOption");
          [...serviceOption.options].forEach((option) => {
            if (option.value === serviceName) {
              option.remove();
            }
          });
        }

        // Refresh both Grooming and Veterinary services
        function refreshServices() {
          fetchServices("Grooming", "groomingServicesTable");
          fetchServices("Veterinary", "veterinaryServicesTable");
        }

        // ------------------------
        // Form Submission Handlers
        // ------------------------

        // Handle edit service form submission
        document.getElementById("editServiceForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const id = document.getElementById("editServiceId").value;
    const name = document.getElementById("editServiceName").value;
    const price = document.getElementById("editServicePrice").value;
    const description = document.getElementById("editServiceDescription").value;
    const imageFile = document.getElementById("editServiceImage").files[0];

    // Validate price
    if (isNaN(price) || price < 0) {
        alert("‚ùå Please enter a valid price (non-negative number).");
        return;
    }

    const formData = new FormData();
    formData.append("service_name", name); // Use service_name instead of id
    formData.append("price", price);
    formData.append("description", description);
    if (imageFile) {
        formData.append("image", imageFile);
    }

    console.log("Sending update request with data:", { name, price, description, imageFile });

    fetch("http://192.168.1.65/backend/update_service.php", {
        method: "POST",
        body: formData,
    })
        .then((res) => {
            if (!res.ok) {
                throw new Error(`HTTP error! Status: ${res.status}`);
            }
            return res.json();
        })
        .then((data) => {
            console.log("Update response:", data);
            if (data.success) {
                alert("‚úÖ Service updated successfully!");
                // Update the image preview immediately
                if (data.image) {
                    document.getElementById("editPreviewImage").src = `http://192.168.1.65/backend/${data.image}`;
                }
                closeModal("editServiceModal");
                refreshServices(); // Refresh the table
            } else {
                alert("‚ùå Update failed: " + (data.error || "Unknown error"));
            }
        })
        .catch((error) => {
            console.error("Fetch error:", error);
            alert("‚ùå Something went wrong: " + error.message);
        });
});

        // Handle add service form submission
        document
          .getElementById("addServiceForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const serviceName = document.getElementById("serviceOption").value;
            const servicePrice = document.getElementById("servicePrice").value;
            const serviceDescription =
              document.getElementById("serviceDescription").value;

            const imageFile = document.getElementById("serviceImage").files[0];
            if (!imageFile) {
              alert("‚ùå Please select an image.");
              return;
            }

            const formData = new FormData();
            formData.append("type", currentServiceType);
            formData.append("service_name", serviceName);
            formData.append("price", servicePrice);
            formData.append("description", serviceDescription);
            formData.append("image", imageFile);

            fetch(apiBaseUrl + "create_service.php", {
              method: "POST",
              body: formData,
            })
              .then((res) => {
                  if (!res.ok) {
                      throw new Error(`HTTP error! Status: ${res.status}`);
                  }
                  return res.json();
              })
              .then((response) => {
                  console.log("Add service response:", response);
                  if (response.success) {
                      alert("‚úÖ Service added successfully!");
                      closeModal("addServiceModal");
                      refreshServices();
                      removeFromDropdown(serviceName);
                  } else {
                      alert("‚ùå Failed to add service: " + (response.error || "Unknown error"));
                  }
              })
              .catch((error) => {
                  console.error("Error adding service:", error);
                  alert("‚ùå Something went wrong: " + error.message);
              });
          });

        // ------------------------
        // Initialization
        // ------------------------

        document.addEventListener("DOMContentLoaded", function () {
          refreshServices();
        });

        // Expose functions for inline HTML event handling
        window.sortTable = sortTable;
        window.openAddServiceModal = openAddServiceModal;
        window.openEditModal = openEditModal;
        window.removeServiceFromModal = removeServiceFromModal;
        window.closeModal = closeModal;
        window.openModal = openModal;
      })();
    </script>
    <script>
      function toggleNav() {
        const navRight = document.querySelector('.nav-right');
        navRight.classList.toggle('active');
      }
    </script>
    
    <script src="index.js"></script>
    <script src="notification.js"></script>
  </body>
</html>